<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="_htmresc/mini-st.css" />
</head>
<body>
<h1 id="testapp_m33td-demonstration-application">TestApp_M33TD
Demonstration Application</h1>
<hr />
<h2 id="application-description">Application Description</h2>
<p>The TestApp_M33TD demonstration highlights the capabilities of the
STM32MP2 platform for the M33TDCID profile, showcasing the Cortex‑M33 as
the primary CPU and the Cortex‑A35 as a high-performance
coprocessor.</p>
<p>This project uses the “Utility-integrated” design and enables the
CM33‑NS <strong>Non‑Secure Application Manager</strong> bootstrap based
on the shared utility stack <code>Utilities/M33TD_NSAppCore</code>
(Logger, RemoteProc, SCMI Manager, Watchdog Monitor, OpenAMP, etc.).
Board-specific drivers and adaptations for this demonstration are
implemented under
<code>CM33/NonSecure/FREERTOS/M33TD_NSAppCore/AppDriver/</code>.</p>
<p>TestApp then demonstrates how to build a custom application on top of
this common stack by adding a dedicated <strong>TestApp Task</strong>,
which runs a sequence of HAL-based functional tests to validate platform
configuration and example peripherals in the non-secure (NS)
environment.</p>
<hr />
<h2 id="key-features">Key Features</h2>
<ul>
<li><strong>FreeRTOS Multitasking</strong>: Runs multiple tasks in the
non-secure environment.</li>
<li><strong>Integrate Utility Stack</strong>: Uses
<code>Utilities/M33TD_NSAppCore</code> for reusable tasks and thin
driver abstractions.</li>
<li><strong>A35 Coprocessor Management</strong>: Uses the RemoteProc
task to manage the A35 core lifecycle via TF‑M secure services.</li>
<li><strong>UserApp Task</strong>: LED activity task to validate system
liveness.</li>
<li><strong>TestApp Task</strong>: Runs a suite of tests sequentially
(automatic/manual behavior controlled by build options).</li>
<li><strong>Optional Display Pipeline</strong>: Same build-time display
option support as the shared stack (see <code>BUILD_CONFIG</code> /
<code>BOOT_SPLASHSCREEN</code>).</li>
</ul>
<hr />
<h2 id="purpose">Purpose</h2>
<p>This is a FreeRTOS-based multitask application running in the NS
processing environment, while the TF‑M secure application operates in
the secure processing environment. The secure application acts as a
client to process secure services requested by both the A35 and
CM33‑NS.</p>
<p>TestApp implements the Non‑Secure Application Manager around the
<code>Utilities/M33TD_NSAppCore</code> stack. The
<code>NSCoreApp_Init()</code> bootstrap configures the stack and starts
the enabled tasks below:</p>
<ol type="1">
<li><strong>NSCoreApp (Bootstrap)</strong>:
<ul>
<li>Initializes the common stack and starts the enabled tasks.</li>
</ul></li>
<li><strong>Logger Task</strong>:
<ul>
<li>Centralized logging, with optional real-time output.</li>
</ul></li>
<li><strong>UserApp Task</strong>:
<ul>
<li>Example application task (LED activity) to validate system
liveness.</li>
</ul></li>
<li><strong>RemoteProc Task</strong>:
<ul>
<li>Manages the A35 coprocessor lifecycle via TF‑M secure services:
<ul>
<li>Optional auto-start at boot
(<code>REMOTE_PROC_AUTO_START</code>).</li>
<li>CPU status retrieval.</li>
<li>Crash detection and recovery (stop/start sequence).</li>
</ul></li>
</ul></li>
<li><strong>SCMI Manager Task</strong>:
<ul>
<li>Handles SCMI notifications and related TF‑M forwarding.</li>
</ul></li>
<li><strong>Watchdog Monitor Task</strong>:
<ul>
<li>Supervises system health and watchdog-related handling.</li>
</ul></li>
<li><strong>OpenAMP Task</strong>:
<ul>
<li>Provides the RPMsg communication layer used by the stack to interact
with the A35/Linux side.</li>
</ul></li>
<li><strong>Button Monitor Task</strong>:
<ul>
<li>Monitors the USER button and can trigger application-defined actions
(implementation may vary by build configuration).</li>
</ul></li>
<li><strong>Display Task (optional)</strong>:
<ul>
<li>Available when the display pipeline is enabled in the build (see
<code>BUILD_CONFIG=FULL</code>).</li>
</ul></li>
<li><strong>TestApp Task</strong>:</li>
</ol>
<ul>
<li>Executes a sequence of tests to validate the M33 example
functionality under the M33TDCID profile.</li>
</ul>
<hr />
<h2 id="prerequisite-hardware-software-environment-setup">Prerequisite
Hardware &amp; Software Environment Setup</h2>
<ul>
<li><strong>Trusted Firmware-M</strong>: The source code must be
installed under the <code>Middlewares/Third_Party</code> directory with
the path <code>Middlewares/Third_Party/trusted-firmware-m</code>. Ensure
the correct version is used as described in the STM32 MPU release
note.</li>
<li><strong>Supported Devices</strong>: This example runs on STM32MP21xx
devices and has been tested with the STMicroelectronics STM32MP215F-DK
board. It can be tailored to other supported devices and development
boards.</li>
<li><strong>ST-Link Connection</strong>: Connect the ST-Link cable to
the PC USB port to display traces.</li>
</ul>
<h3 id="software-versions">Software Versions</h3>
<ul>
<li><strong>Trusted Firmware-M (TFM)</strong>: Refer to the <a
href="https://wiki.st.com/stm32mpu/Category:Trusted_Firmware-M">Trusted
Firmware-M wiki</a> for recommended versions and integration
details.</li>
<li><strong>External Device Tree (externalDT)</strong>: See the <a
href="https://wiki.st.com/stm32mpu/External_device_tree">External
Device Tree wiki</a> for guidance on obtaining and using external DT
sources.</li>
<li><strong>STM32CubeIDE</strong>: For supported IDE versions and
ecosystem information, refer the <a
href="https://wiki.st.com/stm32mpu/">STM32 MPU wiki</a>.</li>
</ul>
<hr />
<h2 id="artifact-flow-build-sign-deploy">Artifact flow (build → sign →
deploy)</h2>
<p>This is a high-level view; the later sections in this README give the
board-specific filenames and flashing steps.</p>
<pre>
┌──────────────┐
│ TF-M build   │
└─┬────────────┘
  +-> bl2*.stm32
  +-> ddr_phy*_Signed.bin
  +-> tfm_s.bin

┌───────────────────┐
│ CM33-NS app build │
└─┬─────────────────┘
  +-> ${PROJECT_NAME}.bin

┌─────────────────────────────┐
│ postbuild (assemble + sign) │
└─┬───────────────────────────┘
  | inputs: ${PROJECT_NAME}.bin + tfm_s.bin
   +-> tfm-testapp-*_s_ns_Signed.bin

Deploy into OSTL image tree
   bl2*.stm32            -> .../images/stm32mp2-m33td/arm-trusted-firmware-m/bl2
   ddr_phy*_Signed.bin   -> .../images/stm32mp2-m33td/m33-firmware
   tfm-testapp-*_s_ns_Signed.bin -> .../images/stm32mp2-m33td/m33-firmware
</pre>
<hr />
<h2 id="to-build-cmake-project-for-m33tdcid-through-command-line">To
Build CMake Project for M33TDCID (Through Command Line)</h2>
<h3 id="compilation-instructions">Compilation Instructions</h3>
<ul>
<li>Ensure an ARM cross-compiler toolchain with
<code>arm-none-eabi-gcc</code> is available in <code>PATH</code>.</li>
<li>When using <code>-G"Unix Makefiles"</code> on Windows, also ensure
<code>make</code> is available in <code>PATH</code>.</li>
</ul>
<hr />
<h2 id="build-procedure">Build Procedure</h2>
<h3 id="secure-build-tfm">Secure Build (TFM)</h3>
<ol type="1">
<li><p>Navigate to
<code>Firmware/Middlewares/Third_Party/trusted-firmware-m</code>.</p></li>
<li><p>For SD card development mode, execute the following command:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cmake</span> <span class="at">-B</span> config_default <span class="at">-G</span><span class="st">&quot;Unix Makefiles&quot;</span> <span class="at">-DTFM_PLATFORM</span><span class="op">=</span>stm/stm32mp215f_dk <span class="at">-DTFM_TOOLCHAIN_FILE</span><span class="op">=</span>toolchain_GNUARM.cmake <span class="at">-DSTM32_BOOT_DEV</span><span class="op">=</span>sdmmc1 <span class="at">-DTFM_PROFILE</span><span class="op">=</span>profile_medium <span class="at">-DSTM32_M33TDCID</span><span class="op">=</span>ON <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Relwithdebinfo <span class="at">-DNS</span><span class="op">=</span>OFF <span class="at">-DDTS_EXT_DIR</span><span class="op">=&lt;</span>EXT_DT_DIR<span class="op">&gt;</span> -DDTS_BOARD_BL2=stm32mp2/m33-td/mcuboot/stm32mp215f-dk-cm33tdcid-ostl-sdcard-bl2.dts <span class="at">-DDTS_BOARD_S</span><span class="op">=</span>stm32mp2/m33-td/tfm/stm32mp215f-dk-cm33tdcid-ostl-sdcard-s.dts <span class="dt">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>-DDTS_BOARD_NS=stm32mp2/m33-td/tfm/stm32mp215f-dk-cm33tdcid-ostl-ns.dts</span></code></pre></div></li>
<li><p>Build the project:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cmake</span> <span class="at">--build</span> config_default <span class="at">--</span> install</span></code></pre></div></li>
</ol>
<p><strong>Note</strong>: The external DT repository is placed in the
<code>Utilities</code> directory.</p>
<hr />
<h3
id="non-secure-m33-firmware-build-testapp_m33td-application">Non-Secure
M33 Firmware Build (TestApp_M33TD Application)</h3>
<ol type="1">
<li><p>Navigate to
<code>Firmware/Projects/STM32MP215F-DK/Demonstrations/TestApp_M33TD</code>.</p></li>
<li><p>Run the following command:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cmake</span> <span class="at">-G</span><span class="st">&quot;Unix Makefiles&quot;</span> <span class="at">-B</span> build <span class="dt">\</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-DTFM_BUILD_DIR</span><span class="op">=&lt;</span>TFM_BUILD_DIRECTORY<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-DENABLE_AUTO_TEST</span><span class="op">=</span>ON</span></code></pre></div>
<ul>
<li>If <code>TFM_BUILD_DIR</code> is not specified, the default path
<code>Firmware/Middlewares/Third_Party/trusted-firmware-m/config_default</code>
will be used (assuming the TF‑M secure build step is completed).</li>
<li>Common build options (see <code>CMakeLists.txt</code>):
<ul>
<li><code>-DBUILD_CONFIG=FULL|MINIMUM</code> (default:
<code>FULL</code>)
<ul>
<li><code>FULL</code>: enables display pipeline (adds display panel
files and HAL LTDC/LVDS dependencies)</li>
<li><code>MINIMUM</code>: disables display pipeline</li>
</ul></li>
<li><code>-DBOOT_SPLASHSCREEN=DYNAMIC|STATIC</code> (default:
<code>DYNAMIC</code>, only meaningful when
<code>BUILD_CONFIG=FULL</code>)</li>
<li><code>-DREMOTE_PROC_AUTO_START=ON|OFF</code> (default:
<code>ON</code>)
<ul>
<li><code>-DREALTIME_DEBUG_LOG_ENABLED=ON|OFF</code> (default:
<code>OFF</code>)</li>
</ul></li>
<li><code>-DFAULT_EXCEPTION_ENABLE=ON|OFF</code> (default:
<code>ON</code>)</li>
<li><code>-DFAULT_EXCEPTION_BACKTRACE_ENABLE=ON|OFF</code> (default:
<code>ON</code>)
<ul>
<li><code>-DENABLE_AUTO_TEST=ON|OFF</code> (default:
<code>ON</code>)</li>
</ul></li>
</ul></li>
</ul>
<p><strong>Note</strong>: These CMake options are converted into numeric
compile-time macros (<code>...=1</code> or <code>...=0</code>) by the
project CMake logic.</p></li>
<li><p>Build the project:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> <span class="at">-C</span> build all</span></code></pre></div></li>
</ol>
<hr />
<h2 id="to-build-native-stm32cubeide-project">To Build Native
STM32CubeIDE Project</h2>
<h3 id="project-structure">Project Structure</h3>
<pre><code>TestApp_M33TD
├── TestApp_M33TD_CM33
│   ├── TestApp_M33TD_CM33_NonSecure (Non-Secure STM32CubeIDE M33 project)
│   └── TestApp_M33TD_CM33_trusted-firmware-m (Secure CMake project)</code></pre>
<p><strong>Note</strong>: Refer to <a
href="https://wiki.st.com/stm32mpu/How_to_create_an_M33-TD_boot_project_using_STM32CubeIDE#">this
wiki</a> for instructions on importing a CMake project.</p>
<h3 id="build-procedure-1">Build Procedure</h3>
<h4 id="secure-tfm-firmware-build">Secure TFM Firmware Build</h4>
<ol type="1">
<li>Configure the CMake build options:
<ul>
<li><p>Navigate to <code>TestApp_M33TD_CM33_trusted-firmware-m</code>
and update the CMake settings:</p>
<pre><code>-DDEBUG_AUTHENTICATION=FULL  # Enabled for Debug Purpose, Default: this option is removed
-DTFM_PLATFORM=stm/stm32mp215f_dk
-DTFM_TOOLCHAIN_FILE=toolchain_GNUARM.cmake

-DSTM32_BOOT_DEV=sdmmc1  # Building TFM for &quot;sdcard_sdcard&quot; bootdevice mode
-DTFM_PROFILE=profile_medium
-DSTM32_M33TDCID=ON
-DCMAKE_BUILD_TYPE=Relwithdebinfo
-DNS=OFF
-DDTS_EXT_DIR=../../../../../../../../../Firmware/Utilities/dt-stm32mp
-DDTS_BOARD_BL2=stm32mp2/m33-td/mcuboot/stm32mp215f-dk-cm33tdcid-ostl-sdcard-bl2.dts
-DDTS_BOARD_S=stm32mp2/m33-td/tfm/stm32mp215f-dk-cm33tdcid-ostl-sdcard-s.dts
-DDTS_BOARD_NS=stm32mp2/m33-td/tfm/stm32mp215f-dk-cm33tdcid-ostl-ns.dts</code></pre></li>
</ul></li>
<li>Configure the TFM CMake project:
<ul>
<li>Right-click on <code>TestApp_M33TD_CM33_trusted-firmware-m</code>
-&gt; <code>CMake Configure</code>.</li>
</ul></li>
<li>Build the TFM CMake project:
<ul>
<li>Right-click on <code>TestApp_M33TD_CM33_trusted-firmware-m</code>
-&gt; <code>Build Project</code>.</li>
</ul></li>
</ol>
<h4 id="non-secure-stm32cubeide-project-build">Non-Secure STM32CubeIDE
Project Build</h4>
<ol type="1">
<li>Build the project:
<ul>
<li>Select the build configuration as per the TFM version:
<ul>
<li>Choose <code>CM33TDCID_m33_ns_tfm_s_sign</code>.</li>
</ul></li>
<li>Right-click on <code>TestApp_M33TD_CM33_NonSecure</code> -&gt;
<code>Build Project</code>.</li>
</ul></li>
</ol>
<hr />
<h2 id="output">Output</h2>
<ul>
<li>The generated binaries will be located in the <code>bin</code>
folder:</li>
</ul>
<pre><code>cd bin/</code></pre>
<ul>
<li><code>${PROJECT_NAME}.bin</code></li>
<li><code>tfm-testapp-*_s_ns_Signed.bin</code></li>
<li><code>ddr_phy*_Signed.bin</code></li>
<li><code>bl2*.stm32</code></li>
</ul>
<hr />
<h2 id="testapp-task-configuration">TestApp Task Configuration</h2>
<p>The <strong>TestApp Task</strong> is responsible for running a
sequence of M33 example tests. Each test follows these steps: 1. Acquire
the required resources to run the test. 2. Initialize the necessary
peripherals. 3. Execute the test. 4. Deinitialize the test and release
the acquired resources.</p>
<h3 id="test-categories">Test Categories</h3>
<p>Tests are categorized into two types based on their execution
requirements: - <strong>AUTO</strong>: Tests that can be executed
without external dependencies. - <strong>MANUAL</strong>: Tests that
require external dependencies or user interaction.</p>
<h3 id="controlling-test-execution">Controlling Test Execution</h3>
<p>While building the <code>TestApp_M33TD</code>, the test execution
behavior can be controlled by passing the following CMake options or
CubeIDE preprocessor definitions:</p>
<h4 id="scenario-1-enable_auto_test-is-on-set-to-1"><strong>Scenario 1:
ENABLE_AUTO_TEST is ON (Set to 1)</strong></h4>
<ul>
<li><strong>Behavior</strong>:
<ul>
<li>The TestApp will execute automatically.</li>
<li><strong>AUTO</strong> tests will be fully executed, including all
steps (AcquireResource → Init → Run → Deinit → ReleaseResource).</li>
<li><strong>MANUAL</strong> tests will be partially executed, performing
only the resource acquisition and release steps (AcquireResource →
ReleaseResource).</li>
</ul></li>
</ul>
<h4 id="scenario-2-enable_auto_test-is-off-set-to-0"><strong>Scenario 2:
ENABLE_AUTO_TEST is OFF (Set to 0)</strong></h4>
<ul>
<li><strong>Behavior</strong>:
<ul>
<li>The TestApp will execute tests fully based on <strong>User Button
2</strong> actions.</li>
<li>Both <strong>AUTO</strong> and <strong>MANUAL</strong> tests will be
executed completely (AcquireResource → Init → Run → Deinit →
ReleaseResource).</li>
</ul></li>
</ul>
<h3 id="how-to-run-manual-tests">How to Run Manual Tests</h3>
<h4 id="i3c-test">I3C Test</h4>
<ul>
<li>Ensure the target I2C board is ready before executing the I3C
controller test.</li>
<li>Refer to the examples provided at
<code>Firmware/Projects/STM32MP215F-DK/Examples/I3C</code> to set up the
target I2C board.</li>
</ul>
<h4 id="spi-test">SPI Test</h4>
<ul>
<li>Ensure the slave SPI board is ready before executing the SPI Master
test.</li>
<li>Refer to the examples provided at
<code>Firmware/Projects/STM32MP215F-DK/Examples/SPI</code> to set up the
slave board for testing.</li>
</ul>
<hr />
<h3 id="example-cmake-options">Example CMake Options</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">-DENABLE_AUTO_TEST=ON</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-DENABLE_AUTO_TEST=OFF</span></span></code></pre></div>
<h3 id="example-cubeide-preprocessor-definitions">Example CubeIDE
Preprocessor Definitions</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ENABLE_AUTO_TEST<span class="op">=</span><span class="dv">1</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ENABLE_AUTO_TEST<span class="op">=</span><span class="dv">0</span></span></code></pre></div>
<hr />
<h4 id="uart-console-output">UART Console Output</h4>
<p>Below is a sample UART log output from the CM33 during the boot and
runtime sequence:</p>
<pre><code>[INF] Loading gpt header

[INF] welcome to MCUboot: ...
[INF] cpu: STM32MP215...
[INF] board: stm32mp215f dk
[INF] dts: stm32mp215f-dk-cm33tdcid-ostl-sdcard-bl2.dts
[INF] boot device: sdmmc1
...
[INF] welcome to TF-M: ...
[INF] dts: stm32mp215f-dk-cm33tdcid-ostl-sdcard-s.dts
...
[NS] [INF] Non-Secure system starting...
[NS] [INF] STM32Cube FW version: ...
[NS] [INF] [WdgMonitor] watchdog timeout: ...
[NS] [INF] [OpenAMP] waiting remote processor initialisation...
[NS] [INF] [RemoteProc] starting copro cpu@0... (pending)
[NS] [INF] [TestApp] Acquiring resources for test: TIMERS
[NS] [INF] [TestApp] Running test: TIMERS
[NS] [INF] [RemoteProc] copro cpu@0 started.
[NS] [INF] [TestApp] Test TIMERS: PASSED
[NS] [INF] [TestApp] Releasing resources for test: TIMERS
[NS] [INF] [TestApp] Acquiring resources for test: SPI
[NS] [INF] [TestApp] Skipping manual test in auto Test mode: SPI
[NS] [INF] [TestApp] Releasing resources for test: SPI
[NS] [INF] [TestApp] Acquiring resources for test: I3C
[NS] [INF] [TestApp] Skipping manual test in auto Test mode: I3C
[NS] [INF] [TestApp] Releasing resources for test: I3C
[NS] [INF] [TestApp] All tests completed.
[NS] [INF] [OpenAMP]  Ready for RPMsg communication</code></pre>
<h3 id="understanding-testapp-logs">Understanding TestApp Logs</h3>
<p>This log demonstrates the CM33 boot sequence (MCUboot/TF-M),
secure→non-secure handover, and the TestApp test execution flow.</p>
<blockquote>
<p><strong>Note:</strong> The presence of
<code>Skipping manual test in auto Test mode: ...</code> indicates the
project was built with <code>ENABLE_AUTO_TEST=1</code> (for example via
<code>-DENABLE_AUTO_TEST=ON</code>).</p>
</blockquote>
<p>The log also reflects the specific firmware and configuration used
for the device boot:</p>
<ul>
<li><strong>STM32Cube FW version</strong>:
<code>STM32Cube FW version: ...</code></li>
<li><strong>MCUboot version</strong>:
<code>welcome to MCUboot: ...</code></li>
<li><strong>TF-M version</strong>:
<code>welcome to TF-M: ...</code></li>
<li><strong>External device tree (DTS)</strong>:
<code>dts: ...-bl2.dts</code> and <code>dts: ...-s.dts</code> (compare
with the <code>-DDTS_BOARD_...</code> options passed to the TF-M secure
build)</li>
</ul>
<p>Key runtime milestones:</p>
<ul>
<li>Display enabled (when <code>BUILD_CONFIG=FULL</code>):
<code>[DisplayTask] Display is initialized and ready...</code></li>
<li>Watchdog monitor:
<code>[WdgMonitor] watchdog timeout: ...</code></li>
<li>A35 bring-up: <code>[RemoteProc] starting ...</code> then
<code>[RemoteProc] copro cpu@0 started.</code></li>
<li>TestApp progress:
<ul>
<li>Test start/finish lines (for example:
<code>Running test: ...</code>, <code>Test ...: PASSED</code>,
<code>All tests completed.</code>)</li>
<li>Auto-test behavior for MANUAL tests (for example:
<code>Skipping manual test in auto Test mode: ...</code>)</li>
</ul></li>
<li>RPMsg ready:
<code>[OpenAMP]  Ready for RPMsg communication</code></li>
</ul>
<p>To verify that the correct configuration is reflected, compare the
DTS filename(s) and firmware versions shown in the log with the TF-M
secure-build CMake options and external DTS files specified during the
secure build.</p>
<h3 id="how-to-test-and-verify-system-behavior">How to Test and Verify
System Behavior</h3>
<p>Once the system has completed boot (for example, you see
<code>[RemoteProc] copro cpu@0 started.</code> and
<code>[OpenAMP]  Ready for RPMsg communication</code>), you can run the
checks below. For each test, look for the corresponding activity on the
<strong>CM33 UART console</strong>.</p>
<ol type="1">
<li><strong>Verify TestApp automatic mode
(<code>ENABLE_AUTO_TEST=1</code>)</strong>
<ul>
<li>Build with <code>-DENABLE_AUTO_TEST=ON</code>.</li>
<li>Expected CM33 logs:
<ul>
<li><code>[TestApp] ... Running test: ...</code> for
<strong>AUTO</strong> tests</li>
<li><code>[TestApp] Skipping manual test in auto Test mode: ...</code>
for <strong>MANUAL</strong> tests</li>
<li><code>[TestApp] All tests completed.</code></li>
</ul></li>
</ul></li>
<li><strong>Verify TestApp manual mode (<code>ENABLE_AUTO_TEST=0</code>,
USER2-triggered)</strong>
<ul>
<li>Build with <code>-DENABLE_AUTO_TEST=OFF</code>.</li>
<li>Press <strong>USER2</strong> to trigger the TestApp sequence as
described in <a href="#testapp-task-configuration">TestApp Task
Configuration</a>.</li>
<li>Expected CM33 logs: both <strong>AUTO</strong> and
<strong>MANUAL</strong> tests execute fully (no “Skipping manual test”
messages).</li>
</ul></li>
<li><strong>Button-triggered A35 reboot (USER2, very long
press)</strong>
<ul>
<li>Press <strong>USER2</strong> for <strong>at least 5
seconds</strong>.</li>
<li>When the OpenAMP power endpoint is enabled in the common stack, the
Button Monitor task can trigger an M33-initiated reboot request to the
remote processor.</li>
<li>Expected CM33 logs (may vary by build options):
<ul>
<li><code>[OpenAMP] request remote processor reboot</code></li>
<li>RemoteProc messages reflecting stop/start or recovery.</li>
</ul></li>
</ul></li>
<li><strong>Simulate a Linux crash and observe recovery</strong>
<ul>
<li>On the Linux console (as <code>root</code>), run:
<code>bash  sync; sleep 2; sync; echo c &gt; /proc/sysrq-trigger</code></li>
<li>On the CM33 UART, RemoteProc should report crash detection and
attempt recovery (stop/start sequence).</li>
</ul></li>
<li><strong>Cold reset from Linux</strong>
<ul>
<li>On Linux, run: <code>bash  reboot</code></li>
<li>You should see MCUboot/TF-M banners again on the CM33 UART.</li>
</ul></li>
<li><strong>Warm reset from Linux</strong>
<ul>
<li>On Linux, run:
<code>bash  echo warm &gt;&gt; /sys/kernel/reboot/mode  reboot</code></li>
<li>A warm reset typically restarts the A35 while keeping CM33 running;
on the CM33 UART you should see the relevant SCMI notification and
RemoteProc/OpenAMP re-init sequence (messages may vary by build
options).</li>
</ul></li>
</ol>
<h2 id="error-behaviors">Error Behaviors</h2>
<p>If an error occurs during initialization or system configuration at
runtime, <strong>LED3 will blink at a 100 ms interval</strong> to
indicate the error state.</p>
<h2 id="assumptions">Assumptions</h2>
<h2 id="known-limitations">Known Limitations</h2>
<h2 id="keywords">Keywords</h2>
<p>Security, TFM, Secure, SD Card, Non-Secure</p>
<hr />
<h2 id="how-to-flash-binaries">How to Flash Binaries</h2>
<ol type="1">
<li><p><strong>Build/Compile the Project</strong> Follow the <a
href="#build-procedure">Build Procedure</a> to generate the required
binaries.</p></li>
<li><p><strong>Copy and Rename Generated Binaries</strong> Before
copying, <strong>rename the generated binaries</strong>
(<code>bl2*.stm32</code>, <code>ddr_phy*_Signed.bin</code>, and
<code>tfm-testapp-*_s_ns_Signed.bin</code>) according to the names
specified in the <strong>Required Binaries</strong> section of the
relevant flash layout under <a
href="#reference-use-cases-for-mp21-dk-board-testapp-project">Reference
Use Cases for MP21-DK Board (TestApp Project)</a>.</p>
<p>Then, copy the renamed binaries to the following paths:</p>
<pre><code>&lt;OSTL-IMAGE-PATH&gt;/images/stm32mp2-m33td/arm-trusted-firmware-m/bl2</code></pre>
<ul>
<li>Place the renamed <code>bl2</code> binary in this directory.</li>
</ul>
<pre><code>&lt;OSTL-IMAGE-PATH&gt;/images/stm32mp2-m33td/m33-firmware</code></pre>
<ul>
<li>Place the renamed <code>ddr_phy</code> and <code>tfm-testapp</code>
binaries in this directory.</li>
</ul></li>
<li><p><strong>Modify Flashlayout (TSV)</strong> Select the relevant TSV
file under
<code>&lt;OSTL-IMAGE-PATH&gt;/images/stm32mp2-m33td/flashlayout_st-image-weston/optee</code>
(see <a href="#flash-layouts-for-mp21-dk-board">Flash Layouts for
MP21-DK Board</a>). Replace the existing TF-M NS signed binary name with
your renamed <code>tfm-testapp-..._s_ns_Signed.bin</code>.</p></li>
</ol>
<hr />
<h2 id="different-boot-device-modes-for-mp21-dk-board">Different Boot
Device Modes for MP21-DK Board</h2>
<ol type="1">
<li><strong>sdcard_sdcard</strong>:
<ul>
<li>MCUBOOT/TFM(S/NS) → SD card</li>
<li>OSTL → SD card</li>
</ul></li>
</ol>
<hr />
<h2 id="flash-layouts-for-mp21-dk-board">Flash Layouts for MP21-DK
Board</h2>
<ul>
<li><code>FlashLayout_sdcard_stm32mp215f-dk-cm33tdcid-ostl-optee.tsv</code></li>
</ul>
<p><strong>Note</strong>: This TSV requires three binaries (BL2, DDR PHY
firmware, and the combined TF‑M S+NS signed image). Refer to the <a
href="#reference-use-cases-for-mp21-dk-board-testapp-project">Reference
Use Cases for MP21-DK Board (TestApp Project)</a> section.</p>
<hr />
<h2 id="reference-use-cases-for-mp21-dk-board-testapp-project">Reference
Use Cases for MP21-DK Board (TestApp Project)</h2>
<h3
id="flashlayout_sdcard_stm32mp215f-dk-cm33tdcid-ostl-optee.tsv-sdcard_sdcard-boot-mode">1.
FlashLayout_sdcard_stm32mp215f-dk-cm33tdcid-ostl-optee.tsv
(sdcard_sdcard Boot Mode)</h3>
<p><strong>Required Binaries</strong>: -
<code>bl2-stm32mp215f-dk-cm33tdcid-ostl-sdcard.stm32</code> -
<code>ddr_phy-stm32mp215f-dk-cm33tdcid-ostl-sdcard_Signed.bin</code> -
<code>tfm-testapp-stm32mp215f-dk-cm33tdcid-ostl-sdcard-sdcard_s_ns_Signed.bin</code></p>
<p><strong>Required CMake Options</strong>:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">-DSTM32_BOOT_DEV=sdmmc1</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-DDTS_BOARD_BL2=stm32mp2/m33-td/mcuboot/stm32mp215f-dk-cm33tdcid-ostl-sdcard-bl2.dts</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-DDTS_BOARD_S=stm32mp2/m33-td/tfm/stm32mp215f-dk-cm33tdcid-ostl-sdcard-s.dts</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">-DDTS_BOARD_NS=stm32mp2/m33-td/tfm/stm32mp215f-dk-cm33tdcid-ostl-ns.dts</span></span></code></pre></div>
<hr />
</body>
</html>
